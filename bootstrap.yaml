- name: Bootstrap a new host, create a personal user and ansible with SSH Key access etc
  hosts: all
  tasks:
    - name: Create user
      ansible.builtin.user:
        name: "{{ item }}"
        shell: /bin/bash
        groups: sudo
        append: true
        state: present
        createhome: true
        generate_ssh_key: true
        password: "{{ users[item] | eyaml | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string) }}"
      loop: "{{ users.keys() }}"
      when: users is defined
    - name: Allow SSH access
      ansible.posix.authorized_key:
        user: "{{ item }}"
        key: https://github.com/chriscn.keys
        state: present
      loop: "{{ users.keys() }}"
    - name: Disable password ssh access
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^PasswordAuthentication"
        line: "PasswordAuthentication no"
        state: present
      notify: ssh::restart
    - name: Install Docker on hosts
      ansible.builtin.include_role:
        name: geerlingguy.docker
      vars:
        docker_users: "{{ users }}"
        docker_install_compose: true
      when: enable_docker
    - name: Create /srv/docker directory
      ansible.builtin.file:
        path: /srv/docker
        owner: root
        group: docker
        state: directory
        mode: "0755"
      when: enable_docker
    - name: Harden system security
      ansible.builtin.import_role:
        name: geerlingguy.security
  handlers:
    - name: ssh::restart
      ansible.builtin.service:
        name: sshd
        state: restarted
  vars:
    ansible_user: root
